name: Process Data Review Submission

on:
  issues:
    types: [labeled]

jobs:
  process:
    if: github.event.label.name == 'accepted' && contains(github.event.issue.labels.*.name, 'data-review')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Parse issue body
        id: parse
        run: python .github/scripts/parse_review_issue.py "${{ github.event.issue.number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply changes
        id: update
        run: python .github/scripts/update_technique_map.py
        env:
          SUBMISSION_DATA: ${{ steps.parse.outputs.submission_json }}

      - name: Commit and push
        if: steps.update.outputs.changes_summary
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/model_technique_map.json
          git commit -m "data: apply review submission #${{ github.event.issue.number }}" -m "${{ steps.update.outputs.changes_summary }}"
          git pull --rebase origin main
          git push

      - name: Comment and close issue (success)
        if: steps.update.outputs.changes_summary
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Submission processed and committed to main.\n\n**Changes:** ${{ steps.update.outputs.changes_summary }}`
            });
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });

      - name: Comment and close issue (no changes)
        if: "!steps.update.outputs.changes_summary"
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'No changes were needed (likely a duplicate submission).'
            });
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });

  handle-failure:
    needs: process
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Comment on issue (failure)
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Automated processing failed. A maintainer will review this submission manually.'
            })
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['processing-failed']
            })
